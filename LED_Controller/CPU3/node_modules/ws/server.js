const WebSocket = require('ws');
const { v4: uuidv4 } = require('uuid');

const server = new WebSocket.Server({ port: 81 });
const clients = new Map();

server.on('connection', (socket) => {
    const clientId = uuidv4();
    clients.set(clientId, socket);
    console.log(`${clientId}: Connected! Client Total: ${clients.size}`);

    socket.on('message', (message) => {
        console.log(`${clientId}: Sent us message: ${message}`);
        clients.forEach((client, id) => {
            if (socket !== client && client.readyState === WebSocket.OPEN) {
                client.send(message);
                console.log(`${id}: Was sent message: ${message}`);
            }
        });
    });

    socket.on('close', () => {
        console.log(`${clientId}: Disconnected!`);
        clients.delete(clientId);
    });
});
